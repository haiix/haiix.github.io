<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¢‹ã®ãƒã‚ºãƒŸ - AIå¯¾æˆ¦ & ãƒ«ãƒ¼ãƒ«èª¿æ•´ (ä¿®æ­£ç‰ˆ)</title>
    <style>
        :root {
            --cell-size: 55px;
            --bg-color: #f0f4f8;
            --board-bg: #fff;
            --highlight-color: #d1fae5;
            --last-move-color: #fef3c7;
            --marble-color: #3b82f6;
            --rat-color: #ef4444;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        h1 { margin-bottom: 10px; font-size: 1.5rem; }
        
        /* ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            width: 100%;
            max-width: 900px;
        }

        /* è¨­å®šãƒ‘ãƒãƒ« */
        .settings-panel {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 350px;
            flex-shrink: 0;
        }
        .settings-group {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .settings-group h3 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            color: #555;
        }
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .setting-row label { font-size: 0.85rem; font-weight: bold; }
        input, select { padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem;}
        
        button#start-btn {
            width: 100%;
            padding: 12px;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
        }
        button#start-btn:hover { background-color: #059669; }

        /* ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        #game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
        }

        .game-info {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-weight: bold;
            flex-wrap: wrap;
            justify-content: center;
        }
        .status-box {
            background: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 0.9rem;
        }
        .phase-indicator {
            color: #d97706;
            font-size: 1.2rem;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
            min-height: 1.5em;
        }

        /* ãƒœãƒ¼ãƒ‰ */
        #game-board {
            display: grid;
            gap: 2px;
            background-color: #94a3b8;
            border: 4px solid #64748b;
            user-select: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            background-color: var(--board-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            cursor: default;
            transition: background-color 0.2s;
            position: relative;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
        .cell.highlight { 
            background-color: var(--highlight-color); 
            cursor: pointer; 
        }
        .cell.last-move {
            background-color: var(--last-move-color);
        }
        
        .cell.marble::after {
            content: "";
            width: 70%;
            height: 70%;
            background-color: var(--marble-color);
            border-radius: 50%;
            box-shadow: inset -2px -2px 5px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .cell.rat::after {
            content: "ğŸ­";
            font-size: 1.6rem;
            animation: slideIn 0.2s ease-out;
        }

        @keyframes popIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }
        @keyframes slideIn {
            from { transform: scale(0.8); opacity: 0.8; }
            to { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 600px) {
            :root { --cell-size: 40px; }
            .container { flex-direction: column; }
            .settings-panel { max-width: 100%; }
        }
    </style>
</head>
<body>

    <h1>è¢‹ã®ãƒã‚ºãƒŸ - AIå¯¾æˆ¦ç‰ˆ</h1>

    <div style="background:#e0f2fe; padding:12px; border-radius:8px; margin-bottom:20px; width:90%; max-width:900px; color:#0c4a6e; font-size:0.9rem; box-sizing:border-box;">
        <h3 style="margin:0 0 5px 0; font-size:1rem;">ğŸ“– ãƒ«ãƒ¼ãƒ«èª¬æ˜</h3>
        <ul style="margin:0; padding-left:20px;">
            <li><strong>ãƒ“ãƒ¼ç‰å½¹</strong>ï¼šç©ºã„ã¦ã„ã‚‹ãƒã‚¹ã«ãƒ“ãƒ¼ç‰ã‚’ç½®ã„ã¦ã€ãƒã‚ºãƒŸã‚’è¿½ã„è¾¼ã¿ã¾ã™ã€‚</li>
            <li><strong>ãƒã‚ºãƒŸå½¹</strong>ï¼šãƒ“ãƒ¼ç‰ã®ãªã„ãƒã‚¹ã¸ç§»å‹•ã—ã¦é€ƒã’ã¾ã™ã€‚</li>
            <li><strong>å‹åˆ©æ¡ä»¶</strong>ï¼š
                ãƒã‚ºãƒŸãŒå‹•ã‘ãªããªã‚Œã°<strong>ãƒ“ãƒ¼ç‰ã®å‹ã¡</strong>ã€
                ç‰ã‚’ä½¿ã„åˆ‡ã£ã¦é€ƒã’ã‚Œã°<strong>ãƒã‚ºãƒŸã®å‹ã¡</strong>ï¼
            </li>
        </ul>
    </div>

    <div class="container">
        <!-- è¨­å®šã‚¨ãƒªã‚¢ -->
        <div class="settings-panel">
            <div class="settings-group">
                <h3>ğŸ“œ ãƒ«ãƒ¼ãƒ«è¨­å®š</h3>
                <div class="setting-row">
                    <label>ãƒœãƒ¼ãƒ‰ã‚µã‚¤ã‚º</label>
                    <input type="number" id="board-size" value="5" min="3" max="8" style="width:50px;">
                </div>
                <div class="setting-row">
                    <label>ãƒ“ãƒ¼ç‰ç·æ•°</label>
                    <input type="number" id="total-marbles" value="12" min="1" max="60" style="width:50px;">
                </div>
                <div class="setting-row">
                    <label>ãƒã‚ºãƒŸç§»å‹•</label>
                    <select id="move-type">
                        <option value="4" selected>4æ–¹å‘ (æ¨å¥¨)</option>
                        <option value="8">8æ–¹å‘ (æ¨™æº–)</option>
                    </select>
                </div>
                <div class="setting-row">
                    <label>1ã‚¿ãƒ¼ãƒ³ã®è¨­ç½®æ•°</label>
                    <select id="marbles-per-turn">
                        <option value="1" selected>1å€‹</option>
                        <option value="2">2å€‹</option>
                    </select>
                </div>
            </div>

            <div class="settings-group">
                <h3>ğŸ¤– ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š</h3>
                <div class="setting-row">
                    <label>ãƒ“ãƒ¼ç‰å½¹ (P1)</label>
                    <select id="p1-type">
                        <option value="human">äººé–“</option>
                        <option value="ai-random">AI (ã‚ˆã‚ã„)</option>
                        <option value="ai-smart">AI (ã‹ã—ã“ã„)</option>
                    </select>
                </div>
                <div class="setting-row">
                    <label>ãƒã‚ºãƒŸå½¹ (P2)</label>
                    <select id="p2-type">
                        <option value="human">äººé–“</option>
                        <option value="ai-random">AI (ã‚ˆã‚ã„)</option>
                        <option value="ai-smart" selected>AI (ã‹ã—ã“ã„)</option>
                    </select>
                </div>
                <div class="setting-row">
                    <label>é–‹å§‹ãƒ•ã‚§ãƒ¼ã‚º</label>
                    <select id="start-phase">
                        <option value="place">ãƒ“ãƒ¼ç‰å…ˆæ”» (æ¨™æº–)</option>
                        <option value="move">ãƒã‚ºãƒŸå…ˆæ”»</option>
                    </select>
                </div>
            </div>

            <button id="start-btn" onclick="initGame()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <div style="margin-top:10px; font-size:0.8rem; color:#666;">
                â€»AIåŒå£«ã«ã™ã‚‹ã¨è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚<br>
                â€»AIã®æ€è€ƒæ™‚é–“ã¯ãƒœãƒ¼ãƒ‰ã‚µã‚¤ã‚ºãŒå¤§ãã„ã¨é•·ããªã‚Šã¾ã™ã€‚
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ é€²è¡Œã‚¨ãƒªã‚¢ -->
        <div id="game-area" style="display:none;">
            <div class="phase-indicator" id="phase-display">æº–å‚™å®Œäº†</div>
            
            <div class="game-info">
                <div class="status-box">æ®‹ã‚Šãƒ“ãƒ¼ç‰: <span id="marble-count">0</span></div>
                <div class="status-box" id="turn-box">æ‰‹ç•ª: <span id="current-role">-</span></div>
            </div>

            <div id="game-board"></div>
            <div id="ai-status" style="height: 20px; color: #888; font-size: 0.8rem; margin-top:5px;"></div>
        </div>
    </div>

    <script>
        // --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç† ---
        const state = {
            boardSize: 5,
            maxMarbles: 10,
            marblesRemaining: 10,
            marblesPerTurn: 1,
            placedThisTurn: 0,
            moveType: 4,
            
            board: [], // 0:Empty, 1:Marble, 2:Rat
            ratPos: {r: 0, c: 0},
            
            // å½¹å‰²ã¨ãƒ•ã‚§ãƒ¼ã‚º
            phase: 'place', // 'place', 'move', 'end'
            winner: null,
            lastMove: null, // {r, c} for highlighting

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š
            players: {
                marble: 'human', // 'human', 'ai-random', 'ai-smart'
                rat: 'human'
            },
            
            isProcessingAI: false
        };

        const boardEl = document.getElementById('game-board');
        const phaseEl = document.getElementById('phase-display');
        const marbleCountEl = document.getElementById('marble-count');
        const currentRoleEl = document.getElementById('current-role');
        const aiStatusEl = document.getElementById('ai-status');

        // --- åˆæœŸåŒ– ---
        function initGame() {
            // è¨­å®šèª­ã¿è¾¼ã¿
            state.boardSize = parseInt(document.getElementById('board-size').value);
            state.maxMarbles = parseInt(document.getElementById('total-marbles').value);
            state.marblesPerTurn = parseInt(document.getElementById('marbles-per-turn').value);
            state.moveType = parseInt(document.getElementById('move-type').value);
            state.players.marble = document.getElementById('p1-type').value;
            state.players.rat = document.getElementById('p2-type').value;
            const startPhase = document.getElementById('start-phase').value;

            // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            state.marblesRemaining = state.maxMarbles;
            state.placedThisTurn = 0;
            state.winner = null;
            state.lastMove = null;
            state.isProcessingAI = false;
            state.board = Array(state.boardSize).fill(0).map(() => Array(state.boardSize).fill(0));

            // ãƒã‚ºãƒŸã‚’ä¸­å¤®ã«é…ç½®
            const center = Math.floor(state.boardSize / 2);
            state.ratPos = { r: center, c: center };
            state.board[center][center] = 2;

            // ãƒ•ã‚§ãƒ¼ã‚ºè¨­å®š
            state.phase = startPhase;

            // UIè¡¨ç¤ºåˆ‡æ›¿
            document.getElementById('game-area').style.display = 'flex';
            boardEl.style.gridTemplateColumns = `repeat(${state.boardSize}, 1fr)`;

            updateUI();
            renderBoard();
            
            // AIã®æ‰‹ç•ªãªã‚‰é–‹å§‹
            checkAI();
        }

        // --- æç”»é–¢é€£ ---
        function renderBoard() {
            boardEl.innerHTML = '';
            const validMoves = (state.phase === 'move' && !state.winner) 
                               ? getValidMoves(state.board, state.ratPos, state.moveType) : [];

            // ç¾åœ¨ã®æ‰‹ç•ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒäººé–“ã‹ã©ã†ã‹
            const isHumanTurn = (state.phase === 'place' && state.players.marble === 'human') ||
                                (state.phase === 'move' && state.players.rat === 'human');

            for (let r = 0; r < state.boardSize; r++) {
                for (let c = 0; c < state.boardSize; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    
                    const cellValue = state.board[r][c];
                    if (cellValue === 1) cell.classList.add('marble');
                    if (cellValue === 2) cell.classList.add('rat');
                    
                    // ç›´å‰ã®æ‰‹ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    if (state.lastMove && state.lastMove.r === r && state.lastMove.c === c) {
                        cell.classList.add('last-move');
                    }

                    // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆäººé–“ã‹ã¤å‹è² ãŒã¤ã„ã¦ã„ã‚‹å ´åˆä»¥å¤–ã€ã‹ã¤AIå‡¦ç†ä¸­ã§ã¯ãªã„ï¼‰
                    if (isHumanTurn && !state.winner && !state.isProcessingAI) {
                        // ãƒ“ãƒ¼ç‰é…ç½®
                        if (state.phase === 'place' && cellValue === 0) {
                            cell.style.cursor = 'pointer';
                            cell.onclick = () => handlePlaceMarble(r, c);
                        }
                        // ãƒã‚ºãƒŸç§»å‹•
                        else if (state.phase === 'move' && validMoves.some(m => m.r === r && m.c === c)) {
                            cell.classList.add('highlight');
                            cell.onclick = () => handleRatMove(r, c);
                        }
                    }
                    boardEl.appendChild(cell);
                }
            }
        }

        function updateUI() {
            marbleCountEl.textContent = state.marblesRemaining;
            
            if (state.winner) {
                const winnerName = state.winner === 'rat' ? 'ãƒã‚ºãƒŸ' : 'ãƒ“ãƒ¼ç‰è½ã¨ã—å½¹';
                const color = state.winner === 'rat' ? '#ef4444' : '#3b82f6';
                phaseEl.innerHTML = `<span style="color:${color}">å‹è² ã‚ã‚Šï¼ ${winnerName} ã®å‹åˆ©ï¼</span>`;
                currentRoleEl.textContent = 'çµ‚äº†';
                aiStatusEl.textContent = '';
                return;
            }

            if (state.phase === 'place') {
                const remaining = state.marblesPerTurn - state.placedThisTurn;
                phaseEl.textContent = `ãƒ“ãƒ¼ç‰é…ç½® (${remaining}å€‹)`;
                phaseEl.style.color = '#3b82f6';
                currentRoleEl.textContent = `ãƒ“ãƒ¼ç‰å½¹ (${getPlayerLabel(state.players.marble)})`;
            } else {
                phaseEl.textContent = 'ãƒã‚ºãƒŸç§»å‹•';
                phaseEl.style.color = '#ef4444';
                currentRoleEl.textContent = `ãƒã‚ºãƒŸå½¹ (${getPlayerLabel(state.players.rat)})`;
            }
        }

        function getPlayerLabel(type) {
            if (type === 'human') return 'ã‚ãªãŸ';
            if (type === 'ai-random') return 'AI(å¼±)';
            return 'AI(å¼·)';
        }

        // --- ã‚²ãƒ¼ãƒ é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ ---

        function handlePlaceMarble(r, c) {
            if (state.board[r][c] !== 0) return;

            state.board[r][c] = 1;
            state.marblesRemaining--;
            state.placedThisTurn++;
            state.lastMove = {r, c};

            // 1. ãƒã‚ºãƒŸè©°ã¿åˆ¤å®š
            if (getValidMoves(state.board, state.ratPos, state.moveType).length === 0) {
                state.winner = 'marble';
                updateAndRender();
                return;
            }

            // 2. ãƒ•ã‚§ãƒ¼ã‚ºé€²è¡Œåˆ¤å®š
            if (state.placedThisTurn >= state.marblesPerTurn || state.marblesRemaining <= 0) {
                state.phase = 'move';
                state.placedThisTurn = 0;
            }

            updateAndRender();
            checkAI();
        }

        function handleRatMove(r, c) {
            // ç§»å‹•å‡¦ç†
            state.board[state.ratPos.r][state.ratPos.c] = 0;
            state.ratPos = {r, c};
            state.board[r][c] = 2;
            state.lastMove = {r, c};

            // 3. ãƒ“ãƒ¼ç‰åˆ‡ã‚Œåˆ¤å®šï¼ˆãƒã‚ºãƒŸå‹åˆ©ï¼‰
            if (state.marblesRemaining === 0) {
                state.winner = 'rat';
                updateAndRender();
                return;
            }

            // ãƒ•ã‚§ãƒ¼ã‚ºåˆ‡ã‚Šæ›¿ãˆ
            state.phase = 'place';
            updateAndRender();
            checkAI();
        }

        function updateAndRender() {
            updateUI();
            renderBoard();
        }

        // --- AIãƒ­ã‚¸ãƒƒã‚¯ ---

        function checkAI() {
            if (state.winner) return;

            let aiType = null;
            if (state.phase === 'place' && state.players.marble.startsWith('ai')) {
                aiType = state.players.marble;
            } else if (state.phase === 'move' && state.players.rat.startsWith('ai')) {
                aiType = state.players.rat;
            }

            if (aiType) {
                state.isProcessingAI = true;
                aiStatusEl.textContent = 'AIæ€è€ƒä¸­...';
                renderBoard(); // ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã§ä¸€å›æç”»
                setTimeout(() => runAI(aiType), 500);
            } else {
                aiStatusEl.textContent = '';
            }
        }

        function runAI(aiType) {
            const isSmart = aiType === 'ai-smart';
            
            if (state.phase === 'place') {
                // ãƒ“ãƒ¼ç‰AI
                let move;
                if (!isSmart) {
                    move = getRandomMarbleMove();
                } else {
                    move = getSmartMarbleMove();
                }
                
                if (move) {
                    handlePlaceMarble(move.r, move.c);
                } else {
                    // ç½®ã‘ã‚‹å ´æ‰€ãŒãªã„ï¼ˆç†è«–ä¸Šã‚ã‚Šãˆãªã„ãŒå¿µã®ãŸã‚ï¼‰
                    state.phase = 'move'; 
                    state.placedThisTurn = 0;
                    updateAndRender();
                    checkAI();
                }

            } else {
                // ãƒã‚ºãƒŸAI
                let move;
                if (!isSmart) {
                    move = getRandomRatMove();
                } else {
                    move = getSmartRatMove();
                }

                if (move) {
                    handleRatMove(move.r, move.c);
                } else {
                    // å‹•ã‘ãªã„ï¼ˆè©°ã¿ï¼‰ã¯ handlePlaceMarble ã§åˆ¤å®šæ¸ˆã¿ã ãŒå¿µã®ãŸã‚
                    state.winner = 'marble';
                    updateAndRender();
                }
            }
            
            // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: AIå‡¦ç†å®Œäº†å¾Œã«ãƒ•ãƒ©ã‚°ã‚’æˆ»ã—ã€å†æç”»ã—ã¦äººé–“ã®å…¥åŠ›ã‚’å—ã‘ä»˜ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹
            state.isProcessingAI = false;
            renderBoard();
        }

        // ãƒ©ãƒ³ãƒ€ãƒ AI
        function getRandomMarbleMove() {
            const emptyCells = [];
            for(let r=0; r<state.boardSize; r++) {
                for(let c=0; c<state.boardSize; c++) {
                    if (state.board[r][c] === 0) emptyCells.push({r, c});
                }
            }
            if (emptyCells.length === 0) return null;
            return emptyCells[Math.floor(Math.random() * emptyCells.length)];
        }

        function getRandomRatMove() {
            const moves = getValidMoves(state.board, state.ratPos, state.moveType);
            if (moves.length === 0) return null;
            return moves[Math.floor(Math.random() * moves.length)];
        }

        // ã‹ã—ã“ã„AI (æ¢ç´¢ä»˜ã)
        function getSmartRatMove() {
            const moves = getValidMoves(state.board, state.ratPos, state.moveType);
            if (moves.length === 0) return null;

            // 1æ‰‹èª­ã¿ + åˆ°é”å¯èƒ½é ˜åŸŸè©•ä¾¡ (Flood Fill)
            let bestScore = -1;
            let bestMoves = [];

            for (let move of moves) {
                // ä»®ç§»å‹•
                const originalPos = state.ratPos;
                state.board[originalPos.r][originalPos.c] = 0;
                state.board[move.r][move.c] = 2;
                state.ratPos = move;

                // è©•ä¾¡: ã“ã®ä½ç½®ã‹ã‚‰åˆ°é”ã§ãã‚‹ãƒã‚¹ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                const score = countReachableCells(state.board, move, state.moveType);

                // çŠ¶æ…‹æˆ»ã™
                state.board[move.r][move.c] = 0;
                state.board[originalPos.r][originalPos.c] = 2;
                state.ratPos = originalPos;

                if (score > bestScore) {
                    bestScore = score;
                    bestMoves = [move];
                } else if (score === bestScore) {
                    bestMoves.push(move);
                }
            }
            
            return bestMoves[Math.floor(Math.random() * bestMoves.length)];
        }

        function getSmartMarbleMove() {
            // ãƒã‚ºãƒŸã®å‘¨å›²2ãƒã‚¹ä»¥å†…ã®ç©ºããƒã‚¹ã‚’å€™è£œã¨ã™ã‚‹
            const candidates = [];
            const range = 2; 
            const rMin = Math.max(0, state.ratPos.r - range);
            const rMax = Math.min(state.boardSize - 1, state.ratPos.r + range);
            const cMin = Math.max(0, state.ratPos.c - range);
            const cMax = Math.min(state.boardSize - 1, state.ratPos.c + range);

            for (let r = rMin; r <= rMax; r++) {
                for (let c = cMin; c <= cMax; c++) {
                    if (state.board[r][c] === 0) {
                        candidates.push({r, c});
                    }
                }
            }

            if (candidates.length === 0) {
                return getRandomMarbleMove();
            }

            let bestScore = 9999;
            let bestMoves = [];

            for (let move of candidates) {
                // ä»®ç½®ã
                state.board[move.r][move.c] = 1;

                // è©•ä¾¡: ãƒã‚ºãƒŸã®æ¬¡ã®æ‰‹ã®è‡ªç”±åº¦
                const ratMoves = getValidMoves(state.board, state.ratPos, state.moveType);
                let score = ratMoves.length * 10;
                
                // çŠ¶æ…‹æˆ»ã™
                state.board[move.r][move.c] = 0;

                if (score < bestScore) {
                    bestScore = score;
                    bestMoves = [move];
                } else if (score === bestScore) {
                    bestMoves.push(move);
                }
            }

            return bestMoves[Math.floor(Math.random() * bestMoves.length)];
        }

        // åˆ°é”å¯èƒ½ãƒã‚¹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        function countReachableCells(board, startPos, moveType) {
            const q = [startPos];
            const visited = new Set();
            visited.add(`${startPos.r},${startPos.c}`);
            let count = 0;

            while(q.length > 0) {
                const curr = q.shift();
                count++;
                
                const moves = getValidMoves(board, curr, moveType);
                for(let m of moves) {
                    const key = `${m.r},${m.c}`;
                    if(!visited.has(key)) {
                        visited.add(key);
                        q.push(m);
                    }
                }
            }
            return count;
        }

        // --- å…±é€šãƒ­ã‚¸ãƒƒã‚¯ ---
        function getValidMoves(board, pos, moveType) {
            const moves = [];
            const directions = [];
            // 4æ–¹å‘
            directions.push({dr:-1, dc:0}, {dr:1, dc:0}, {dr:0, dc:-1}, {dr:0, dc:1});
            // 8æ–¹å‘
            if (moveType === 8) {
                directions.push({dr:-1, dc:-1}, {dr:-1, dc:1}, {dr:1, dc:-1}, {dr:1, dc:1});
            }

            for (let d of directions) {
                const nr = pos.r + d.dr;
                const nc = pos.c + d.dc;
                if (nr >= 0 && nr < state.boardSize && nc >= 0 && nc < state.boardSize) {
                    if (board[nr][nc] === 0) {
                        moves.push({r: nr, c: nc});
                    }
                }
            }
            return moves;
        }
    </script>
</body>
</html>